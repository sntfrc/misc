#!/bin/sh

chrome --headless --remote-debugging-port=7777 --use-fake-ui-for-media-stream --autoplay-policy=no-user-gesture-required --audio file://$(realpath $0)

exit 0

<!DOCTYPE html>

<html lang="it">
  <head>
    <meta charset="utf-8">
    <title>Dimmelo</title>
  </head>

  <body onload="document.body.firstChild.textContent=''">
    <table>
      <tr><th>Delay:</th><th>dB thresh.:</th></tr>
      <tr>
        <td><input type="range" min="1000" max="5000" value="2000" id="delay" onchange="update_params()"></td>
        <td><input type="range" min="-90" max="0" value="-60" id="threshold" onchange="update_params()"></td>
      </tr>
      <tr><td><span id="delay_v"></span></td><td><span id="threshold_v"></td></tr>
    </table>

    <script>
      let ROGER_BEEP =  "data:audio/mpeg;base64,SUQzAwAAAAAfdkNPTU0AAAAPAAAAZW5nAGV4Y2VsbGVudCFUQUxCAAAAFwAAAGZyZWUtc291bmQtZWZmZWN0cy5uZXRUQ09OAAAABQAAAFJvY2tUSVQyAAAALAAAAGJlZXAgbWluaWR2IGNhbWVyYSBtZW51IGRvdWJsZSBzb3VuZCBlZmZlY3RUUEUxAAAAFwAAAGZyZWUtc291bmQtZWZmZWN0cy5uZXRUUEUyAAAALwAAAf/+ZgByAGUAZQAtAHMAbwB1AG4AZAAtAGUAZgBmAGUAYwB0AHMALgBuAGUAdABUUkNLAAAABgAAADA0LzE2VFlFUgAAAAUAAAAyMDE2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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";
      
      let TIMER_MS = null;
      let THRESHOLD = null;

      function update_params() {
        TIMER_MS = document.getElementById("delay").value;
        THRESHOLD = document.getElementById("threshold").value;
        document.getElementById("delay_v").innerHTML = TIMER_MS;
        document.getElementById("threshold_v").innerHTML = THRESHOLD;
      }

      update_params();

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          const mediaRecorder = new MediaRecorder(stream);
          const audioChunks = [];
          mediaRecorder.addEventListener("dataavailable", event => {
            audioChunks.push(event.data);
          });

          const audioContext = new AudioContext();
          const audioStreamSource = audioContext.createMediaStreamSource(stream);

          const analyser = audioContext.createAnalyser();
          analyser.maxDecibels = 0;
          analyser.minDecibels = THRESHOLD;
          audioStreamSource.connect(analyser);

          const bufferLength = analyser.frequencyBinCount;
          const domainData = new Uint8Array(bufferLength);

          let last_sound_ts = new Date();
          let recording = false;
          let playback = false;

          const detectSound = () => {
            analyser.getByteFrequencyData(domainData);

            for (let i = 0; i < bufferLength; i++) {
              const value = domainData[i];

              if (domainData[i] > 0) {
                if (!recording && !playback) {
                  recording = true;
                  mediaRecorder.start();
                }

                last_sound_ts = new Date();
              }
            }

            if (Math.abs(new Date() - last_sound_ts) > TIMER_MS) {
              if (recording) {
                recording = false;
                mediaRecorder.stop();
              }
            }

            window.requestAnimationFrame(detectSound);
          };

          window.requestAnimationFrame(detectSound);

          mediaRecorder.addEventListener("stop", () => {
            const audioBlob = new Blob(audioChunks);
            audioChunks.pop();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.addEventListener("ended", () => {
              const beep = new Audio(ROGER_BEEP);
              beep.addEventListener("ended", () => {
                playback = false;
              });
              beep.play();
            });
            playback = true;
            audio.play();
          });
        });
    </script>
  </body>

</html>

